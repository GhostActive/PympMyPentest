"""
rating.py - Contains classes to work with vulnerability severities
"""
# 
# GNU General Public License v3.0
#
# Copyright (c) 2020-2021 GhostActive
#
# For more information see
#   https://github.com/GhostActive/PympMyPentest
# 
import itertools
from enum import Enum, EnumMeta
from typing import Union, Tuple


class RatingMeta(EnumMeta):
    """
    Helper class to get 'Rating' items by priority or name.
    """

    def __call__(cls, value: Union[float, int, str], **kwargs):
        """
        Converts the given name (str), priority (int) or CVSS v3.X score
        (float) to corresponding 'Rating' item.

        Args:
            value: corresponding name, priority or CVSS v3.X score of 'Rating'
                   item

        Returns:
            Returns the corresponding 'Rating' item to given name or priority.
        """
        if isinstance(value, str):
            return RatingMeta.from_name(value)
        elif isinstance(value, int):
            return RatingMeta.from_priority(value)
        elif isinstance(value, float):
            return RatingMeta.from_cvss_score(value)

        raise TypeError(f"Unexpected type: {type(value)} (value={value})")

    @classmethod
    def from_name(cls, value: str) -> "Rating":
        """

        """
        return Rating.__getitem__(value.upper())

    @classmethod
    def from_priority(cls, value: int) -> "Rating":
        """

        """
        return next(itertools.islice(Rating, value + 1, None))

    @classmethod
    def from_cvss_score(cls, score: float) -> "Rating":
        """
        Creates a new instance of 'Rating' class by given CVSSv3.0 or CVSSv3.1
        score.

        Args:
            score: rating representation as float

        Returns:
            Returns for the given score the corresponding entry from 'Rating'
            enumeration class.

        Raises:
            ValueError: If the score values is negative a ValueError is thrown.
        """
        if score < 0.0:
            raise ValueError(f"Score must be positive: {score}")

        # Reduce errors in floating-point arithmetic by converting score to int
        score = min(int(score * 10), 100)

        if score < 1:
            return Rating.NONE
        elif score < 40:
            return Rating.LOW
        elif score < 70:
            return Rating.MEDIUM
        elif score < 90:
            return Rating.HIGH
        else:
            return Rating.CRITICAL


class Rating(Enum, metaclass=RatingMeta):
    """
    'Rating' class is used to prioritize and compare various severity or
    vulnerability objects. The enumeration contains six different items for
    mapping priorization.

    For more information, see
        https://github.com/GhostActive/PympMyPentest/blob/main/doc/rating.md
    """

    UNKNOWN = ("Unknown", -1)
    NONE = ("None", 0)
    LOW = ("Low", 1)
    MEDIUM = ("Medium", 2)
    HIGH = ("High", 3)
    CRITICAL = ("Critical", 4)

    @property
    def name(self) -> str:
        """
        Returns the current item's name - first letter is upper case followed
        by lower case letters.

        Returns:
            Returns the current item's name.
        """
        return self._value_[0]

    @property
    def priority(self) -> int:
        """
        Returns the the current item's integer representation.

        Returns:
            Returns the current item's priority.
        """
        return self._value_[1]

    @property
    def item(self) -> Tuple[str, int]:
        """
        Returns a tuple containing the current item's name and priority.

        Returns:
            Returns a tuple containing name and priority.
        """
        return self._value_

    def __lt__(self, other: "Rating") -> bool:
        """
        Compares two 'Rating' objects using the '<' (less than) operator.

        Returns:
            Returns 'True' if the other's 'Rating' priority is higher;
            Otherwise 'False'.
        """
        return self.priority < other.priority

    def __str__(self) -> str:
        """
        Returns the current item's name - first letter is upper case followed
        by lower case letters.

        Returns:
            Returns the current item's name.
        """
        return self.name
