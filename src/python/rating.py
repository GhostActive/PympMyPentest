"""
rating.py - contains classes to work with vulnerability severities
"""
#
# MIT License
#
# Copyright (c) 2020-2021 GhostActive
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# AUTHOR: https://github.com/GhostActive
#

from enum import Enum, EnumMeta
from typing import Union


class RatingMeta(EnumMeta):
    """
    Helper class for "Rating" class to construct instances by using item's
    values as well as names.
    """

    def __call__(cls, value: Union[str, int] = 0, names=None, *, module=None, qualname=None, type=None, start=1):
        """
        Converts the given name (str) or value (int) to corresponding "Rating"
        instance.
        """
        if isinstance(value, str):
            return super().__getitem__(value.upper())
        else:
            return super().__call__(value, names, module=module, qualname=qualname, type=type, start=start)


class Rating(Enum, metaclass=RatingMeta):
    """
    The "Rating" class is used to prioritize and compare various "Severity"
    or vulnerability objects. The enumeration contains six different items for
    mapping the priorization. Each item instance has a name for string and an
    integer value for numeric representation:

              -------------------------------------------
                Item              Name           Value
              -------------------------------------------
                Rating.UNKNOWN    Unknown         -1
                Rating.NONE       None             0
                Rating.LOW        Low              1
                Rating.MEDIUM     Medium           2
                Rating.HIGH       High             3
                Rating.CRITICAL   Critical         4
              -------------------------------------------
                Overview about supported severity levels

    Example - Ouput of item, name and value:
    >>> print(Rating.MEDIUM)                # Output: Medium
    >>> print(Rating.MEDIUM.name)           # Output: Medium
    >>> print(Rating.MEDIUM.value)          # Output: 2

    The "Rating" class provides three different ways to create new instances:
        - Direct call of an item
          >>> r1 = Rating.NONE              # Use concrete enumeration item

        - Via constructor
          >>> r2 = Rating(1)                # Input as integer (value)
          >>> r3 = Rating("Medium")         # Input as string (name - case insensitive)

        - Helper function
          >>> r4 = Rating.from_cvss_score(8.5)  # Mapping score value

    When using an unknown string or value as well as an invalid CVSS score an
    error will be thrown.

    Comparison:
        - Comparision of items directly
          >>> r1 = Rating.MEDIUM
          >>> r2 = Rating.MEDIUM
          >>> r3 = Rating.LOW
          >>> r1 == r2                      # Output: True
          >>> r1 == r3                      # Output: False
          >>> r1.value > r3.value           # Output: True

        - Standard integer comparision
          >>> Rating.LOW.value == 2         # Output: True
          >>> Rating.MEDIUM.value == 5      # Output: False
          >>> Rating.HIGH.value > 2         # Output: True
          >>> Rating.LOW == 2               # Raise AttributeError

        - Standard string comparision
          >>> Rating.LOW.name == "Low"      # Output: True  - public name
          >>> Rating.LOW.name == "LOW"      # Output: False - public name
          >>> Rating.LOW._name_ = "LOW"     # Output: True  - Internal name

    Sorting:
        >>> l = [Rating.MEDIUM, Rating.NONE, Rating.LOW] # Order: Medium, None, Low
        >>> l.sort(key=lambda r: r.value, reverse=True)  # Order: Medium, Low, None
    """
    UNKNOWN = -1
    NONE = 0
    LOW = 1
    MEDIUM = 2
    HIGH = 3
    CRITICAL = 4

    @classmethod
    def from_cvss_score(cls, score: float) -> "Rating":
        """
        Creates a new instance of "Rating" class by given CVSSv3.0 or CVSSv3.1
        score. The following ranges are used:

              ------------------------------------------------
                Item              CVSS Rating     CVSS Score
              ------------------------------------------------
                Rating.UNKNOWN    -                -
                Rating.NONE       None             0.0
                Rating.LOW        Low              0.1 - 3.9
                Rating.MEDIUM     Medium           4.0 - 6.9
                Rating.HIGH       High             7.0 - 8.9
                Rating.CRITICAL   Critical         9.0 - 10.0
              ------------------------------------------------
                Mapping of scores to "Rating" objects based on
                official specification for CVSS3.0 [1] and
                CVSS3.1 [2]

        If the score values is negative a ValueError is thrown. A score value
        greater than 10.0 is set to 10.0.

        References:
        [1] https://www.first.org/cvss/v3.0/specification-document
        [2] https://www.first.org/cvss/v3.1/specification-document

        :param score: given severity as CVSS score
        :return: Returns for the given score the corresponding entry from
                 "Severity" enumeration class.
        """
        if score < 0.0:
            raise ValueError("Score must be positive: " + str(score))

        # Reduce errors in floating-point arithmetic by converting score to int
        score = min(int(score * 10), 100)

        if score < 1:
            return Rating.NONE
        elif score < 40:
            return Rating.LOW
        elif score < 70:
            return Rating.MEDIUM
        elif score < 90:
            return Rating.HIGH
        else:
            return Rating.CRITICAL

    @property
    def name(self) -> str:
        """
        Returns the current item's name. The first letter is always upper case
        by followed lower case letters for the rest of the name.

        :return: Returns the current item's name.
        """
        return self._name_.title()

    @property
    def value(self) -> int:
        """
        Returns the current item's value as integer.

        :return: Returns the current item's value as integer.
        """
        return self._value_

    def __str__(self) -> str:
        """
        Returns a string representation of current severity object containing
        the title.

        :return: Returns a string containing the title of current severity
                 object.
        """
        return self._name_.title()

    def __hash__(self) -> int:
        """
        Returns the hash value of current severity object. The hash value is
        based on the entry's title.
        >>> hash(Rating.LOW) == hash("Low")   # Output: True
        >>> hash(Rating.LOW) == hash("LOW")   # Output: False

        :return: Returns the hash value of current severity object.
        """
        return hash(self._name_.title())

