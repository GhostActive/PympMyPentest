"""
rating.py - Contains classes to work with vulnerability severities
"""
# 
# GNU General Public License v3.0
#
# Copyright (c) 2020-2021 GhostActive
#
# For more information see
#   https://github.com/GhostActive/PympMyPentest
# 
import itertools
from enum import Enum, EnumMeta
from typing import Union, Tuple


class RatingMeta(EnumMeta):
    """
    Helper class to get 'Rating' items by priority or name.
    """

    def __call__(cls, value: Union[float, int, str], **kwargs):
        """
        Converts the given name (str), priority (int) or CVSS v3.X score
        (float) to corresponding 'Rating' item.

        Args:
            value: name, priority or score of corresponding 'Rating' item

        Returns:
            Returns the corresponding 'Rating' item to given name, priority or
            score.
        """
        if isinstance(value, str):
            return RatingMeta.from_name(value)
        elif isinstance(value, int):
            return RatingMeta.from_priority(value)
        elif isinstance(value, float):
            return RatingMeta.from_cvss_score(value)

        raise TypeError(f"Unexpected type: {type(value)} (value={value})")

    @classmethod
    def from_name(cls, value: str) -> "Rating":
        """
        Creates a new instance of 'Rating' class by given item name. The method
        is case insensitive.

        Args:
            value: name of the corresponding item

        Returns:
            Returns for the given value the corresponding entry from 'Rating'
            enumeration class.

        Raises:
            KeyError: Raises an exception if the given name doesn't exist.
        """
        return Rating.__getitem__(value.upper())

    @classmethod
    def from_priority(cls, value: int) -> "Rating":
        """
        Creates a new instance of 'Rating' class by given priority.

        Args:
            value: priority of the corresponding item

        Returns:
            Returns for the given value the corresponding entry from 'Rating'
            enumeration class.

        Raises:
            ValueError: Raises an exception if the priority doesn't exist.
        """
        return next(itertools.islice(Rating, value + 1, None))

    @classmethod
    def from_cvss_score(cls, value: float) -> "Rating":
        """
        Creates a new instance of 'Rating' class by given CVSSv3.0 or CVSSv3.1
        score.

        Args:
            value: score representation as float of corresponding item

        Returns:
            Returns for the given value the corresponding entry from 'Rating'
            enumeration class.

        Raises:
            ValueError: If the score values is negative a ValueError is thrown.
        """
        if value < 0.0:
            raise ValueError(f"Score value must be positive: {value}")

        # Reduce errors in floating-point arithmetic by converting score to int
        score = min(int(value * 10), 100)

        if score < 1:
            return Rating.NONE
        elif score < 40:
            return Rating.LOW
        elif score < 70:
            return Rating.MEDIUM
        elif score < 90:
            return Rating.HIGH
        else:
            return Rating.CRITICAL


class Rating(Enum, metaclass=RatingMeta):
    """
    The "Rating" enumeration class contains different items to map priorisation
    level. Each item is represented by a tuple consisting the priority as
    integer and string.
    """

    # Rating class supports the following items:
    UNKNOWN = (-1, "Unknown")
    NONE = (0, "None")
    LOW = (1, "Low")
    MEDIUM = (2, "Medium")
    HIGH = (3, "High")
    CRITICAL = (4, "Critical")

    @property
    def name(self) -> str:
        """
        Returns the current item's name - first letter is upper case followed
        by lower case letters.

        Returns:
            Returns the current item's name.
        """
        return self._value_[1]

    @property
    def priority(self) -> int:
        """
        Returns the the current item's integer representation.

        Returns:
            Returns the current item's priority.
        """
        return self._value_[0]

    @property
    def item(self) -> Tuple[str, int]:
        """
        Returns a tuple containing the current item's name and priority.

        Returns:
            Returns a tuple containing name and priority.
        """
        return self._value_

    def __lt__(self, other: "Rating") -> bool:
        """
        Compares two 'Rating' objects using the '<' (less than) operator. This
        operator is implemented to support the (build-in) method "sort()"

        Returns:
            Returns 'True' if the other's 'Rating' priority is higher;
            Otherwise 'False'.
        """
        return self.priority < other.priority

    def __str__(self) -> str:
        """
        Returns the current item's name - first letter is upper case followed
        by lower case letters.

        Returns:
            Returns the current item's name.
        """
        return self.name
