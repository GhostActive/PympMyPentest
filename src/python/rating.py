"""
rating.py - Contains classes to work with vulnerability severities
"""
#
# MIT License
#
# Copyright (c) 2020-2021 GhostActive
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# For more information, see
#     https://github.com/GhostActive/PympMyPentest/blob/main/content/rating.md
#

from enum import Enum, EnumMeta
from typing import Union, Tuple


class RatingMeta(EnumMeta):
    """
    Helper class for 'Rating' class to construct instances by using item's
    values as well as names.
    """

    def __call__(cls, value: Union[str, int] = 0, names=None, *, module=None, qualname=None, type=None, start=1):
        """
        Converts the given name (str) or value (int) to corresponding "Rating"
        instance.
        """
        if isinstance(value, str):
            return super().__getitem__(value.upper())
        else:
            return super().__call__(value, names, module=module, qualname=qualname, type=type, start=start)


class Rating(Enum, metaclass=RatingMeta):
    """
    The 'Rating' class is used to prioritize and compare various severity or
    vulnerability objects. The enumeration contains six different items for
    mapping priorization.

    Constructor:
        Instances of 'Rating' can be created as follows:

        # Concrete enumeration item
        >>> r1 = Rating.NONE

        # Invoking constructor using name or value
        >>> r2 = Rating(1)
        >>> r3 = Rating("Medium") # case insensitive

        # From CVSS score - named constructor
        >>> r4 = Rating.from_cvss_score(8.5)

    Attributes:
        name: the item's label as string
        priority: integer represantion of the item
        value: tuple containing ('name', priority)

              -------------------------------------------
                Item              Name          Priority
              -------------------------------------------
                Rating.UNKNOWN    Unknown         -1
                Rating.NONE       None             0
                Rating.LOW        Low              1
                Rating.MEDIUM     Medium           2
                Rating.HIGH       High             3
                Rating.CRITICAL   Critical         4
              -------------------------------------------
                Overview about supported levels

    Sortable:
        The 'Rating' class is sortable based on 'Rating.priority'.

        >>> l = [Rating.MEDIUM, Rating.NONE, Rating.LOW]
        >>> sorted(l)
        [<Rating.NONE: ('None', 0)>, <Rating.LOW: ('Low', 1)>, <Rating.MEDIUM: ('Medium', 2)>]
        >>> sorted(l, reverse = True)
        [<Rating.MEDIUM: ('Medium', 2)>, <Rating.LOW: ('Low', 1)>, <Rating.NONE: ('None', 0)>]

    Raises:
        KeyError: Raises KeyError, if the given string doesn't match an item's
                  name. (Constructor)
        ValueError: Raises ValueError, if the given integer number doesn't
                    match an item's value. (Constructor)
    """

    UNKNOWN = ("Unknown", -1)
    NONE = ("None", 0)
    LOW = ("Low", 1)
    MEDIUM = ("Medium", 2)
    HIGH = ("High", 3)
    CRITICAL = ("Critical", 4)

    @classmethod
    def from_cvss_score(cls, score: float) -> "Rating":
        """
        Creates a new instance of 'Rating' class by given CVSSv3.0 or CVSSv3.1
        score.

        Args:
            score: rating representation as float. The following ranges are
                   used:

                      ------------------------------------------------
                        Item              CVSS Rating     CVSS Score
                      ------------------------------------------------
                        Rating.UNKNOWN    -                -
                        Rating.NONE       None             0.0
                        Rating.LOW        Low              0.1 - 3.9
                        Rating.MEDIUM     Medium           4.0 - 6.9
                        Rating.HIGH       High             7.0 - 8.9
                        Rating.CRITICAL   Critical         9.0 - 10.0
                      ------------------------------------------------
                        Mapping of scores to 'Rating' objects based on
                        official specification for CVSS3.0 [1] and
                        CVSS3.1 [2]

                   A score value greater than 10.0 is set to 10.0.
        Returns:
            Returns for the given score the corresponding entry from 'Rating'
            enumeration class.

        Raises:
            ValueError: If the score values is negative a ValueError is thrown.

        References:
            [1] https://www.first.org/cvss/v3.0/specification-document
            [2] https://www.first.org/cvss/v3.1/specification-document
        """
        if score < 0.0:
            raise ValueError("Score must be positive: " + str(score))

        # Reduce errors in floating-point arithmetic by converting score to int
        score = min(int(score * 10), 100)

        if score < 1:
            return Rating.NONE
        elif score < 40:
            return Rating.LOW
        elif score < 70:
            return Rating.MEDIUM
        elif score < 90:
            return Rating.HIGH
        else:
            return Rating.CRITICAL

    @property
    def name(self) -> str:
        """
        Returns the current item's name. The first letter is always upper case
        by followed lower case letters for the rest of the name.

        Returns:
            Returns the current item's name.
        """
        return self._value_[0]

    @property
    def priority(self) -> int:
        """
        Returns the integer representation of the current item's.

        Returns:
            Returns the current item's priority.
        """
        return self._value_[1]

    @property
    def value(self) -> Tuple[str, int]:
        """
        Returns the current item's name and priority as tuple.

        Returns:
            Returns a tuple containing name and priority.
        """
        return self._value_

    def __lt__(self, other: "Rating") -> bool:
        """
        Compares two 'Rating' objects using the "<" operator.

        Returns:
            Returns 'True' if the other's 'Rating.priority' is higher;
            Otherwise 'False'.
        """
        return self.priority < other.priority

    def __str__(self) -> str:
        """
        Returns the current item's string representation.

        Returns:
            Returns 'Priority.name'.
        """
        return self.name
